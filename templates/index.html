<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Gallery</title>
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <h1>üñºÔ∏è AI Gallery</h1>
            <span class="status-indicator" id="aiStatus">üî¥ AI Offline</span>
        </div>
        
        <div class="header-center">
            <div class="search-box">
                <input 
                    type="text" 
                    id="searchInput" 
                    placeholder="Search images..." 
                    autocomplete="off"
                >
                <button id="searchBtn" aria-label="Search images">üîç</button>
            </div>
        </div>
        
        <div class="header-right">
            <button class="btn btn-primary" id="uploadBtn" aria-label="Upload images from your computer">üì§ Upload</button>
            <button class="btn btn-primary" id="scanBtn" aria-label="Scan photos directory for new images">üìÇ Scan</button>
            <button class="btn btn-secondary" id="analyzeBtn" aria-label="Analyze multiple images with AI">ü§ñ Analyze</button>
            <button class="btn btn-secondary" id="selectBtn" aria-label="Select multiple images">‚úì Select</button>

            <!-- Advanced Tools Dropdown -->
            <div style="position: relative; display: inline-block;">
                <button class="btn btn-secondary" id="toolsMenuBtn" aria-label="Advanced tools">üõ†Ô∏è Tools ‚ñæ</button>
                <div id="toolsDropdown" style="display: none; position: absolute; right: 0; top: 100%; margin-top: 4px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--border-radius); box-shadow: 0 4px 12px rgba(0,0,0,0.3); min-width: 200px; z-index: 1000;">
                    <button class="dropdown-item" id="sortImagesBtn" style="display: block; width: 100%; text-align: left; padding: var(--spacing-sm) var(--spacing-md); background: none; border: none; cursor: pointer; color: var(--text-color);">üîÑ Sort Images</button>
                    <button class="dropdown-item" id="findDuplicatesBtn" style="display: block; width: 100%; text-align: left; padding: var(--spacing-sm) var(--spacing-md); background: none; border: none; cursor: pointer; color: var(--text-color);">üîç Find Duplicates</button>
                    <div style="border-top: 1px solid var(--border-color); margin: var(--spacing-xs) 0;"></div>
                    <button class="dropdown-item" id="privacyBtn" style="display: block; width: 100%; text-align: left; padding: var(--spacing-sm) var(--spacing-md); background: none; border: none; cursor: pointer; color: var(--text-color);">üîí Privacy & Protection</button>
                    <button class="dropdown-item" id="researchBtn" style="display: block; width: 100%; text-align: left; padding: var(--spacing-sm) var(--spacing-md); background: none; border: none; cursor: pointer; color: var(--text-color);">üéì Research & Education</button>
                    <button class="dropdown-item" id="workflowsBtn" style="display: block; width: 100%; text-align: left; padding: var(--spacing-sm) var(--spacing-md); background: none; border: none; cursor: pointer; color: var(--text-color);">‚ö° Workflow Automation</button>
                    <button class="dropdown-item" id="exportImportBtn" style="display: block; width: 100%; text-align: left; padding: var(--spacing-sm) var(--spacing-md); background: none; border: none; cursor: pointer; color: var(--text-color);">üì¶ Export/Import Data</button>
                </div>
            </div>

            <button class="btn btn-secondary" id="settingsBtn" aria-label="Open settings">‚öôÔ∏è Settings</button>
        </div>
    </header>

    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-section">
                <h3>Views</h3>
                <ul class="nav-list">
                    <li>
                        <a href="#" class="nav-item active" data-view="all">
                            <span class="icon">üñºÔ∏è</span>
                            <span>All Images</span>
                            <span class="count" id="allCount">0</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" class="nav-item" data-view="favorites">
                            <span class="icon">‚≠ê</span>
                            <span>Favorites</span>
                            <span class="count" id="favCount">0</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" class="nav-item" data-view="unanalyzed">
                            <span class="icon">‚è≥</span>
                            <span>Unanalyzed</span>
                            <span class="count" id="unanalyzedCount">0</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" class="nav-item" data-view="videos">
                            <span class="icon">üé¨</span>
                            <span>Videos</span>
                            <span class="count" id="videosCount">0</span>
                        </a>
                    </li>
                </ul>
            </div>

            <div class="sidebar-section">
                <div class="section-header">
                    <h3>Boards</h3>
                    <button class="btn-icon" id="createBoardBtn" title="Create Board" aria-label="Create new board">+</button>
                </div>
                <ul class="nav-list" id="boardsList">
                    <!-- Boards will be loaded here -->
                </ul>
            </div>

            <div class="sidebar-section">
                <h3>Popular Tags</h3>
                <div class="tag-cloud" id="tagCloud">
                    <!-- Tag cloud will be loaded here -->
                </div>
            </div>

            <div class="sidebar-section stats">
                <h3>Stats</h3>
                <div class="stat-item">
                    <span class="stat-label">Total Images:</span>
                    <span class="stat-value" id="statTotal">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Analyzed:</span>
                    <span class="stat-value" id="statAnalyzed">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Boards:</span>
                    <span class="stat-value" id="statBoards">0</span>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Breadcrumb -->
            <div class="breadcrumb" id="breadcrumb">
                <span class="breadcrumb-item">All Images</span>
            </div>

            <!-- Loading State -->
            <div class="loading-state" id="loadingState" style="display: none;">
                <div class="spinner"></div>
                <p>Loading images...</p>
            </div>

            <!-- Empty State -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <div class="empty-icon">üìÇ</div>
                <h2>No Images Found</h2>
                <p>Scan your photos directory to get started</p>
                <button class="btn btn-primary" id="scanBtnEmpty" aria-label="Scan photos directory for new images">üìÇ Scan Directory</button>
            </div>

            <!-- Image Grid -->
            <div class="image-grid" id="imageGrid">
                <!-- Images will be loaded here -->
            </div>
        </main>
    </div>

    <!-- Image Modal -->
    <div class="modal" id="imageModal" style="display: none;">
        <div class="modal-overlay" id="modalOverlay"></div>
        <div class="modal-content">
            <button class="modal-close" id="modalClose" aria-label="Close modal">&times;</button>

            <div class="modal-body" id="modalBody">
                <!-- Content will be dynamically generated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Create Board Modal -->
    <div class="modal" id="createBoardModal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content modal-small">
            <button class="modal-close" id="createBoardClose" aria-label="Close create board modal">&times;</button>
            
            <div class="modal-body">
                <h2>Create Board</h2>
                
                <form id="createBoardForm">
                    <div class="form-group">
                        <label for="boardName">Board Name *</label>
                        <input type="text" id="boardName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="boardDescription">Description</label>
                        <textarea id="boardDescription" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="boardParent">Parent Board (optional)</label>
                        <select id="boardParent">
                            <option value="">-- Top Level --</option>
                        </select>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancelBoardBtn">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create Board</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add to Board Modal -->
    <div class="modal" id="addToBoardModal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content modal-small">
            <button class="modal-close" id="addToBoardClose" aria-label="Close add to board modal">&times;</button>
            
            <div class="modal-body">
                <h2>Add to Board</h2>
                
                <div class="board-selection" id="boardSelection">
                    <!-- Board checkboxes will be loaded here -->
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelAddToBoardBtn">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveAddToBoardBtn">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Style Selector Modal -->
    <div class="modal" id="aiStyleModal" style="display: none;">
        <div class="modal-overlay" id="aiStyleOverlay"></div>
        <div class="modal-content modal-small">
            <button class="modal-close" id="aiStyleClose" aria-label="Close AI style selector modal">&times;</button>

            <div class="modal-body">
                <h2>Choose Analysis Style</h2>

                <div class="style-selection" id="styleSelection" style="margin-top: var(--spacing-lg);">
                    <!-- Styles will be loaded here -->
                </div>

                <div id="customPromptSection" style="display: none; margin-top: var(--spacing-md);">
                    <div class="form-group">
                        <label for="customPrompt">Custom Prompt:</label>
                        <textarea
                            id="customPrompt"
                            rows="5"
                            placeholder="Enter your custom AI prompt here..."></textarea>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelAIStyleBtn">Cancel</button>
                    <button type="button" class="btn btn-primary" id="analyzeWithStyleBtn">Analyze</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Images Modal -->
    <div class="modal" id="uploadModal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content modal-small">
            <button class="modal-close" id="uploadModalClose" aria-label="Close upload modal">&times;</button>

            <div class="modal-body">
                <h2>Upload Media</h2>

                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">üìÅ</div>
                    <p>Drag and drop images or videos here</p>
                    <p style="color: var(--text-muted); font-size: 0.875rem;">or</p>
                    <button type="button" class="btn btn-primary" id="selectFilesBtn">Select Files</button>
                    <input type="file" id="fileInput" multiple accept="image/*,video/*" style="display: none;">
                </div>
                
                <div id="uploadPreview" style="margin-top: var(--spacing-lg); display: none;">
                    <h3 style="font-size: 0.875rem; margin-bottom: var(--spacing-sm);">Selected Files:</h3>
                    <div id="uploadFileList"></div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancelUploadBtn">Cancel</button>
                        <button type="button" class="btn btn-primary" id="startUploadBtn">Upload</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Rename Board Modal -->
    <div class="modal" id="renameBoardModal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content modal-small">
            <button class="modal-close" id="renameBoardClose" aria-label="Close rename board modal">&times;</button>

            <div class="modal-body">
                <h2>Rename Board</h2>

                <form id="renameBoardForm">
                    <div class="form-group">
                        <label for="renameBoardName">New Name *</label>
                        <input type="text" id="renameBoardName" required>
                    </div>

                    <div class="form-group">
                        <label for="renameBoardDescription">Description</label>
                        <textarea id="renameBoardDescription" rows="3"></textarea>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancelRenameBtn">Cancel</button>
                        <button type="submit" class="btn btn-primary">Rename</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Merge Board Modal -->
    <div class="modal" id="mergeBoardModal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content modal-small">
            <button class="modal-close" id="mergeBoardClose" aria-label="Close merge board modal">&times;</button>

            <div class="modal-body">
                <h2>Merge Board</h2>

                <p style="margin-bottom: var(--spacing-md); color: var(--text-secondary);">
                    Merge <strong id="mergeSourceName"></strong> into another board.
                    All images and sub-boards will be moved.
                </p>

                <form id="mergeBoardForm">
                    <div class="form-group">
                        <label for="mergeTargetBoard">Merge into *</label>
                        <select id="mergeTargetBoard" required>
                            <option value="">-- Select Board --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="mergeDeleteSource" checked>
                            Delete source board after merge
                        </label>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancelMergeBtn">Cancel</button>
                        <button type="submit" class="btn btn-primary">Merge Boards</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Board Modal -->
    <div class="modal" id="deleteBoardModal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content modal-small">
            <button class="modal-close" id="deleteBoardClose" aria-label="Close delete board modal">&times;</button>

            <div class="modal-body">
                <h2>Delete Board</h2>

                <p style="margin-bottom: var(--spacing-md); color: var(--text-secondary);">
                    Are you sure you want to delete <strong id="deleteSourceName"></strong>?
                </p>

                <form id="deleteBoardForm">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="deleteSubBoards">
                            Also delete all sub-boards
                        </label>
                    </div>

                    <p style="font-size: 0.875rem; color: var(--text-muted);">
                        Note: Images will not be deleted, only board relationships.
                    </p>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancelDeleteBtn">Cancel</button>
                        <button type="submit" class="btn btn-danger">Delete Board</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Move Board Modal -->
    <div class="modal" id="moveBoardModal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content modal-small">
            <button class="modal-close" id="moveBoardClose" aria-label="Close move board modal">&times;</button>

            <div class="modal-body">
                <h2>Move Board</h2>

                <p style="margin-bottom: var(--spacing-md); color: var(--text-secondary);">
                    Move <strong id="moveSourceName"></strong> to a new location.
                </p>

                <form id="moveBoardForm">
                    <div class="form-group">
                        <label for="moveTargetBoard">Move to *</label>
                        <select id="moveTargetBoard" required>
                            <option value="">-- Top Level (Make Independent) --</option>
                        </select>
                    </div>

                    <p style="font-size: 0.875rem; color: var(--text-muted);">
                        Select a parent board or choose "Top Level" to make this board independent.
                    </p>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancelMoveBtn">Cancel</button>
                        <button type="submit" class="btn btn-primary">Move Board</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Image Modal -->
    <div class="modal" id="editImageModal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content modal-small">
            <button class="modal-close" id="editImageClose" aria-label="Close edit image modal">&times;</button>

            <div class="modal-body">
                <h2>Edit Image</h2>

                <form id="editImageForm">
                    <div class="form-group">
                        <label for="editImageFilename">Filename *</label>
                        <input type="text" id="editImageFilename" required>
                    </div>

                    <div class="form-group">
                        <label for="editImageDescription">Description</label>
                        <textarea id="editImageDescription" rows="4" placeholder="Enter image description..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="editImageTags">Tags</label>
                        <div id="editTagsContainer" style="display: flex; flex-wrap: wrap; gap: var(--spacing-xs); margin-bottom: var(--spacing-sm);">
                            <!-- Existing tags will be shown here -->
                        </div>
                        <div style="display: flex; gap: var(--spacing-xs);">
                            <input
                                type="text"
                                id="editImageNewTag"
                                placeholder="Add new tag..."
                                style="flex: 1;"
                            >
                            <button type="button" class="btn btn-secondary" id="addTagBtn">+ Add</button>
                        </div>
                        <small>Press Enter or click Add to add a tag</small>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancelEditImageBtn">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal" style="display: none;">
        <div class="modal-overlay" id="settingsOverlay"></div>
        <div class="modal-content" style="max-width: 600px;">
            <button class="modal-close" id="settingsClose" aria-label="Close settings">&times;</button>

            <div class="modal-body">
                <h2>‚öôÔ∏è Settings</h2>

                <!-- Telegram Bot Settings -->
                <div class="settings-section">
                    <h3>üì± Telegram Bot</h3>

                    <div class="bot-status" id="botStatus">
                        <div class="status-indicator">
                            <span class="status-dot" id="botStatusDot">üî¥</span>
                            <span id="botStatusText">Bot Offline</span>
                        </div>
                        <div class="bot-controls">
                            <button class="btn btn-sm btn-primary" id="startBotBtn">‚ñ∂Ô∏è Start</button>
                            <button class="btn btn-sm btn-danger" id="stopBotBtn">‚èπÔ∏è Stop</button>
                            <button class="btn btn-sm btn-secondary" id="testBotBtn">üîç Test</button>
                            <button class="btn btn-sm btn-secondary" id="viewLogsBtn">üìÑ View Logs</button>
                        </div>
                    </div>

                    <div id="botLogsSection" style="display: none; margin-top: var(--spacing-md);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-sm);">
                            <h4 style="margin: 0;">Bot Logs</h4>
                            <button class="btn btn-sm btn-secondary" id="refreshLogsBtn">üîÑ Refresh</button>
                        </div>
                        <pre id="botLogs" style="background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius-sm); padding: var(--spacing-md); max-height: 300px; overflow-y: auto; font-size: 12px; color: var(--text-secondary);"></pre>
                    </div>

                    <form id="botConfigForm">
                        <div class="form-group">
                            <label for="botToken">Bot Token (from @BotFather)</label>
                            <input
                                type="password"
                                id="botToken"
                                placeholder="123456789:ABCdefGHIjklMNOpqrsTUVwxyz"
                                autocomplete="off"
                            >
                            <small>Get your token from <a href="https://t.me/botfather" target="_blank">@BotFather</a> on Telegram</small>
                        </div>

                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="autoAnalyze" checked>
                                Auto-analyze photos with AI
                            </label>
                            <small>Automatically analyze photos when uploaded via Telegram</small>
                        </div>

                        <div class="form-group">
                            <label for="aiStyle">AI Analysis Style</label>
                            <select id="aiStyle">
                                <option value="classic">Classic - Balanced descriptions</option>
                                <option value="detailed">Detailed - Comprehensive analysis</option>
                                <option value="tags">Tags - Focus on keywords</option>
                            </select>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">üíæ Save Configuration</button>
                        </div>
                    </form>

                    <div class="help-text" style="margin-top: var(--spacing-md);">
                        <p><strong>How to use:</strong></p>
                        <ol>
                            <li>Create a bot with @BotFather on Telegram</li>
                            <li>Copy the bot token and paste it above</li>
                            <li>Save configuration and start the bot</li>
                            <li>Add bot to a group or send photos directly</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Board Context Menu -->
    <div class="context-menu" id="boardContextMenu" style="display: none;">
        <div class="context-menu-item" data-action="rename">
            ‚úèÔ∏è Rename
        </div>
        <div class="context-menu-item" data-action="move">
            üìÅ Move to...
        </div>
        <div class="context-menu-item" data-action="merge">
            üîÄ Merge into...
        </div>
        <div class="context-menu-item" data-action="delete">
            üóëÔ∏è Delete
        </div>
    </div>

    <!-- Batch Operations Bar -->
    <div class="batch-operations-bar" id="batchOperationsBar" style="display: none;">
        <div class="batch-info">
            <span id="selectedCount">0</span> selected
            <button class="btn-text" id="selectAllBtn">Select All</button>
            <button class="btn-text" id="deselectAllBtn">Deselect All</button>
        </div>
        <div class="batch-actions">
            <button class="btn btn-sm btn-secondary" id="batchAnalyzeBtn">ü§ñ AI Analysis</button>
            <button class="btn btn-sm btn-secondary" id="batchTagBtn">üè∑Ô∏è AI Tags</button>
            <button class="btn btn-sm btn-secondary" id="batchNameBtn">‚úèÔ∏è AI Names</button>
            <button class="btn btn-sm btn-primary" id="batchAddToBoardBtn">üìå Add to Board</button>
            <button class="btn btn-sm btn-danger" id="closeBatchBtn">‚úï</button>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Image Sort Menu -->
    <div class="context-menu" id="imageSortMenu" style="display: none;">
        <div class="context-menu-item sort-option active" data-sort="date-desc">
            üìÖ Newest First
        </div>
        <div class="context-menu-item sort-option" data-sort="date-asc">
            üìÖ Oldest First
        </div>
        <div class="context-menu-item sort-option" data-sort="name-asc">
            üî§ Name A-Z
        </div>
        <div class="context-menu-item sort-option" data-sort="name-desc">
            üî§ Name Z-A
        </div>
        <div class="context-menu-item sort-option" data-sort="size-desc">
            üìè Largest First
        </div>
        <div class="context-menu-item sort-option" data-sort="size-asc">
            üìè Smallest First
        </div>
    </div>

    <!-- Duplicates Modal -->
    <div class="modal" id="duplicatesModal" style="display: none;">
        <div class="modal-overlay" id="duplicatesOverlay"></div>
        <div class="modal-content" style="max-width: 90vw;">
            <button class="modal-close" id="duplicatesClose" aria-label="Close duplicates finder">&times;</button>

            <div class="modal-body" id="duplicatesBody">
                <h2>üîç Duplicate Images</h2>
                <div id="duplicatesContent">
                    <!-- Duplicate groups will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Export/Import Data Modal -->
    <div class="modal" id="exportImportModal" style="display: none;">
        <div class="modal-overlay" id="exportImportOverlay"></div>
        <div class="modal-content modal-small">
            <button class="modal-close" id="exportImportClose" aria-label="Close export/import modal">&times;</button>

            <div class="modal-body">
                <h2>üì¶ Export / Import Data</h2>

                <div class="settings-section">
                    <h3>üì§ Export Data</h3>
                    <p style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: var(--spacing-md);">
                        Export your images, boards, and tags to use with AI tools like Gemini or Claude
                    </p>

                    <div class="form-group">
                        <label>Export Format:</label>
                        <div style="display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-sm);">
                            <button class="btn btn-secondary" id="exportJsonBtn">üìÑ JSON</button>
                            <button class="btn btn-secondary" id="exportMarkdownBtn">üìù Markdown</button>
                            <button class="btn btn-secondary" id="exportCsvBtn">üìä CSV</button>
                        </div>
                        <small style="color: var(--text-muted);">
                            JSON - Best for AI APIs (Gemini, Claude)<br>
                            Markdown - Human-readable, great for AI prompts<br>
                            CSV - Spreadsheets and data analysis
                        </small>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="exportIncludeImages" checked>
                            Include images metadata
                        </label>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="exportIncludeBoards" checked>
                            Include boards structure
                        </label>
                    </div>
                </div>

                <hr style="border: none; border-top: 1px solid var(--border-color); margin: var(--spacing-lg) 0;">

                <div class="settings-section">
                    <h3>üì• Import Data</h3>
                    <p style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: var(--spacing-md);">
                        Import board organization from AI suggestions or previous exports
                    </p>

                    <div class="form-group">
                        <label for="importJsonData">Paste JSON data:</label>
                        <textarea
                            id="importJsonData"
                            rows="6"
                            placeholder='{"boards": [...], "version": "1.0"}'
                            style="font-family: monospace; font-size: 0.875rem;"
                        ></textarea>
                        <small style="color: var(--text-muted);">
                            Paste the JSON export or AI suggestions here
                        </small>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="importBoards" checked>
                            Import boards structure
                        </label>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="importBoardAssignments" checked>
                            Import image-to-board assignments
                        </label>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="importUpdateExisting">
                            Update existing items
                        </label>
                        <small style="color: var(--text-muted);">
                            If unchecked, existing boards/images will be skipped
                        </small>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-primary" id="importDataBtn">üì• Import Data</button>
                    </div>
                </div>

                <hr style="border: none; border-top: 1px solid var(--border-color); margin: var(--spacing-lg) 0;">

                <div class="help-text">
                    <p><strong>How to use with AI:</strong></p>
                    <ol style="font-size: 0.875rem; color: var(--text-muted);">
                        <li>Export your data (Markdown or JSON)</li>
                        <li>Send to Gemini/Claude with prompt: "Suggest how to organize these images into boards"</li>
                        <li>Copy AI's JSON response</li>
                        <li>Import the suggestions back into AI Gallery</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Privacy Modal -->
    <div class="modal" id="privacyModal" style="display: none;">
        <div class="modal-overlay" id="privacyOverlay"></div>
        <div class="modal-content modal-small">
            <button class="modal-close" id="privacyClose" aria-label="Close privacy modal">&times;</button>

            <div class="modal-body">
                <h2>üîí Privacy & Protection</h2>

                <div class="settings-section">
                    <h3>Privacy Statistics</h3>
                    <div class="stat-item">
                        <span class="stat-label">Images with faces:</span>
                        <span class="stat-value" id="privacyStatFaces">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">NSFW flagged:</span>
                        <span class="stat-value" id="privacyStatNSFW">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Not analyzed:</span>
                        <span class="stat-value" id="privacyStatUnanalyzed">0</span>
                    </div>
                </div>

                <hr style="border: none; border-top: 1px solid var(--border-color); margin: var(--spacing-lg) 0;">

                <div class="settings-section">
                    <h3>üîç Privacy Detection</h3>
                    <p style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: var(--spacing-md);">
                        Automatically detect and blur sensitive content in your images
                    </p>

                    <div class="form-group">
                        <label>What to detect:</label>
                        <label style="display: block; margin-bottom: var(--spacing-xs);">
                            <input type="checkbox" id="detectFaces" checked>
                            Faces (using OpenCV Haar Cascades)
                        </label>
                        <label style="display: block; margin-bottom: var(--spacing-xs);">
                            <input type="checkbox" id="detectPlates" checked>
                            License plates (pattern matching)
                        </label>
                        <label style="display: block; margin-bottom: var(--spacing-xs);">
                            <input type="checkbox" id="detectNSFW">
                            NSFW content (AI-based, experimental)
                        </label>
                    </div>

                    <div class="form-group">
                        <label for="blurStrength">Blur Strength:</label>
                        <input type="range" id="blurStrength" min="10" max="50" value="30" style="width: 100%;">
                        <small style="color: var(--text-muted);">
                            Current: <span id="blurStrengthValue">30</span>
                        </small>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-primary" id="analyzeAllPrivacyBtn">
                            üîç Analyze All Images
                        </button>
                        <button type="button" class="btn btn-secondary" id="analyzeSelectedPrivacyBtn">
                            üîç Analyze Selected
                        </button>
                    </div>
                </div>

                <hr style="border: none; border-top: 1px solid var(--border-color); margin: var(--spacing-lg) 0;">

                <div class="settings-section">
                    <h3>üñºÔ∏è Privacy Mode</h3>
                    <p style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: var(--spacing-md);">
                        When enabled, all images with detected privacy zones will display blurred
                    </p>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: var(--spacing-sm);">
                            <input type="checkbox" id="privacyModeEnabled">
                            <span>Enable Privacy Mode</span>
                        </label>
                        <small style="color: var(--text-muted);">
                            Thumbnails will automatically blur faces and license plates
                        </small>
                    </div>
                </div>

                <hr style="border: none; border-top: 1px solid var(--border-color); margin: var(--spacing-lg) 0;">

                <div class="help-text">
                    <p><strong>How it works:</strong></p>
                    <ol style="font-size: 0.875rem; color: var(--text-muted);">
                        <li>Click "Analyze" to detect faces, license plates, and sensitive content</li>
                        <li>Detected zones are stored in the database</li>
                        <li>Enable Privacy Mode to automatically blur these zones in thumbnails</li>
                        <li>Original images are never modified - blur is applied on-the-fly</li>
                    </ol>

                    <p style="margin-top: var(--spacing-md); font-size: 0.875rem; color: var(--text-muted);">
                        <strong>Note:</strong> Privacy detection uses local processing only. No data is sent to external services.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Research & Education Modal -->
    <div class="modal" id="researchModal" style="display: none;">
        <div class="modal-overlay" id="researchOverlay"></div>
        <div class="modal-body" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <button class="modal-close" id="researchClose" aria-label="Close research modal">&times;</button>
            <h2 style="margin-bottom: var(--spacing-lg);">üéì Research & Education</h2>

            <!-- Tabs -->
            <div class="research-tabs" style="display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-lg); border-bottom: 2px solid var(--bg-secondary);">
                <button class="research-tab active" data-tab="annotations" style="padding: var(--spacing-sm) var(--spacing-md); background: none; border: none; cursor: pointer; border-bottom: 2px solid transparent;">
                    üìù Annotations
                </button>
                <button class="research-tab" data-tab="citations" style="padding: var(--spacing-sm) var(--spacing-md); background: none; border: none; cursor: pointer; border-bottom: 2px solid transparent;">
                    üìö Citations
                </button>
                <button class="research-tab" data-tab="dataset" style="padding: var(--spacing-sm) var(--spacing-md); background: none; border: none; cursor: pointer; border-bottom: 2px solid transparent;">
                    üíæ Dataset Export
                </button>
            </div>

            <!-- Annotations Tab -->
            <div class="research-tab-content" id="annotationsTab">
                <h3>Image Annotations</h3>
                <p style="color: var(--text-muted); margin-bottom: var(--spacing-md);">
                    Draw bounding boxes on images for object detection training.
                </p>

                <div class="dataset-stats" style="background: var(--bg-secondary); padding: var(--spacing-md); border-radius: var(--border-radius); margin-bottom: var(--spacing-lg);">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--spacing-md);">
                        <div class="stat-item">
                            <span class="stat-label">Annotated Images:</span>
                            <span class="stat-value" id="statAnnotatedImages">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Total Annotations:</span>
                            <span class="stat-value" id="statTotalAnnotations">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Classes:</span>
                            <span class="stat-value" id="statTotalClasses">0</span>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: var(--spacing-md);">
                    <label style="display: block; margin-bottom: var(--spacing-xs);">Annotation Class:</label>
                    <div style="display: flex; gap: var(--spacing-sm);">
                        <select id="annotationClassSelect" style="flex: 1; padding: var(--spacing-sm); background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--border-radius);">
                            <option value="">Select or type new class...</option>
                        </select>
                        <button class="btn btn-secondary" id="addNewClassBtn">+ Add Class</button>
                    </div>
                </div>

                <div style="margin-bottom: var(--spacing-lg);">
                    <button class="btn btn-primary" id="startAnnotationBtn">
                        üìù Start Annotating Selected Image
                    </button>
                    <button class="btn btn-secondary" id="importFromPrivacyBtn">
                        üîí Import from Privacy Zones
                    </button>
                </div>

                <div class="class-distribution" id="classDistribution" style="margin-top: var(--spacing-lg);">
                    <h4>Class Distribution</h4>
                    <div id="classDistributionList" style="max-height: 200px; overflow-y: auto;"></div>
                </div>
            </div>

            <!-- Citations Tab -->
            <div class="research-tab-content" id="citationsTab" style="display: none;">
                <h3>Citation Generator</h3>
                <p style="color: var(--text-muted); margin-bottom: var(--spacing-md);">
                    Generate academic citations for your images in various formats.
                </p>

                <div style="margin-bottom: var(--spacing-lg);">
                    <label style="display: block; margin-bottom: var(--spacing-xs);">Citation Format:</label>
                    <select id="citationFormat" style="width: 100%; padding: var(--spacing-sm); background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--border-radius);">
                        <option value="apa">APA (American Psychological Association)</option>
                        <option value="mla">MLA (Modern Language Association)</option>
                        <option value="bibtex">BibTeX (LaTeX)</option>
                        <option value="chicago">Chicago Style</option>
                    </select>
                </div>

                <div style="display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-lg);">
                    <button class="btn btn-primary" id="generateCitationBtn">
                        üìö Generate Citation for Selected
                    </button>
                    <button class="btn btn-secondary" id="generateBatchCitationBtn">
                        üìö Generate for All Selected
                    </button>
                </div>

                <div id="citationOutput" style="display: none; background: var(--bg-secondary); padding: var(--spacing-md); border-radius: var(--border-radius); margin-top: var(--spacing-md);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-sm);">
                        <h4 style="margin: 0;">Generated Citations</h4>
                        <button class="btn btn-secondary btn-sm" id="copyCitationsBtn">üìã Copy All</button>
                    </div>
                    <div id="citationsList" style="font-family: monospace; white-space: pre-wrap; font-size: 0.875rem; max-height: 400px; overflow-y: auto;"></div>
                </div>
            </div>

            <!-- Dataset Export Tab -->
            <div class="research-tab-content" id="datasetTab" style="display: none;">
                <h3>Dataset Export</h3>
                <p style="color: var(--text-muted); margin-bottom: var(--spacing-md);">
                    Export annotated images for machine learning training.
                </p>

                <div class="dataset-stats" style="background: var(--bg-secondary); padding: var(--spacing-md); border-radius: var(--border-radius); margin-bottom: var(--spacing-lg);">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--spacing-md);">
                        <div class="stat-item">
                            <span class="stat-label">Ready to Export:</span>
                            <span class="stat-value" id="statExportReady">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Total Annotations:</span>
                            <span class="stat-value" id="statExportAnnotations">0</span>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: var(--spacing-md);">
                    <label style="display: block; margin-bottom: var(--spacing-xs);">Export Format:</label>
                    <select id="datasetFormat" style="width: 100%; padding: var(--spacing-sm); background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--border-radius);">
                        <option value="coco">COCO Format (JSON) - PyTorch, TensorFlow, Detectron2</option>
                        <option value="yolo">YOLO Format (TXT) - YOLOv5, YOLOv8, Ultralytics</option>
                        <option value="csv">CSV Format - Pandas, Excel, Custom Scripts</option>
                        <option value="zip">ZIP Archive (includes README)</option>
                    </select>
                </div>

                <div style="margin-bottom: var(--spacing-lg);">
                    <label style="display: flex; align-items: center; gap: var(--spacing-sm); cursor: pointer;">
                        <input type="checkbox" id="splitDataset">
                        <span>Create train/val/test splits (70/15/15)</span>
                    </label>
                </div>

                <div style="display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-lg);">
                    <button class="btn btn-primary" id="exportDatasetBtn">
                        üíæ Export Dataset
                    </button>
                    <button class="btn btn-secondary" id="previewDatasetBtn">
                        üëÅÔ∏è Preview
                    </button>
                </div>

                <div id="datasetPreview" style="display: none; background: var(--bg-secondary); padding: var(--spacing-md); border-radius: var(--border-radius); margin-top: var(--spacing-md);">
                    <h4>Dataset Preview</h4>
                    <pre id="datasetPreviewContent" style="font-family: monospace; font-size: 0.75rem; max-height: 300px; overflow-y: auto; white-space: pre-wrap;"></pre>
                </div>

                <div style="margin-top: var(--spacing-lg); padding: var(--spacing-md); background: var(--bg-tertiary); border-radius: var(--border-radius);">
                    <h4 style="margin-bottom: var(--spacing-sm);">üìñ Format Guide</h4>
                    <ul style="margin: 0; padding-left: var(--spacing-lg); font-size: 0.875rem;">
                        <li><strong>COCO:</strong> Industry standard for object detection. Use with PyTorch, TensorFlow.</li>
                        <li><strong>YOLO:</strong> Fast and efficient. Use with YOLOv5/v8, Ultralytics.</li>
                        <li><strong>CSV:</strong> Simple format for custom pipelines and analysis.</li>
                        <li><strong>ZIP:</strong> Complete package with README and all necessary files.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Annotation Canvas Modal -->
    <div class="modal" id="annotationCanvasModal" style="display: none;">
        <div class="modal-overlay" id="annotationCanvasOverlay"></div>
        <div class="modal-body" style="max-width: 95vw; max-height: 95vh; padding: var(--spacing-md);">
            <button class="modal-close" id="annotationCanvasClose" aria-label="Close annotation canvas">&times;</button>
            <h2 style="margin-bottom: var(--spacing-sm);">üìù Image Annotation</h2>

            <div style="display: flex; gap: var(--spacing-md); margin-bottom: var(--spacing-md); align-items: center;">
                <div style="flex: 1;">
                    <label style="margin-right: var(--spacing-sm);">Class:</label>
                    <select id="annotationCanvasClass" style="padding: var(--spacing-xs); background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--border-radius);">
                        <!-- Populated dynamically -->
                    </select>
                </div>
                <button class="btn btn-primary" id="saveAnnotationsBtn">üíæ Save Annotations</button>
                <button class="btn btn-secondary" id="clearAnnotationsBtn">üóëÔ∏è Clear All</button>
            </div>

            <div style="position: relative; max-width: 100%; max-height: 70vh; overflow: auto; background: var(--bg-tertiary); border-radius: var(--border-radius);">
                <canvas id="annotationCanvas" style="display: block; max-width: 100%; height: auto; cursor: crosshair;"></canvas>
            </div>

            <div id="annotationsList" style="margin-top: var(--spacing-md); max-height: 150px; overflow-y: auto;">
                <h4>Current Annotations</h4>
                <div id="annotationsListContent"></div>
            </div>

            <div style="margin-top: var(--spacing-md); padding: var(--spacing-sm); background: var(--bg-secondary); border-radius: var(--border-radius); font-size: 0.875rem;">
                <strong>Instructions:</strong> Click and drag to draw bounding boxes. Select class before drawing. Press Delete key to remove selected box.
            </div>
        </div>
    </div>

    <!-- Workflow Automation Modal -->
    <div class="modal" id="workflowsModal" style="display: none;">
        <div class="modal-overlay" id="workflowsOverlay"></div>
        <div class="modal-body" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
            <button class="modal-close" id="workflowsClose" aria-label="Close workflows modal">&times;</button>
            <h2 style="margin-bottom: var(--spacing-lg);">‚ö° Workflow Automation</h2>

            <!-- Tabs -->
            <div class="workflow-tabs" style="display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-lg); border-bottom: 2px solid var(--bg-secondary);">
                <button class="workflow-tab active" data-tab="pipelines" style="padding: var(--spacing-sm) var(--spacing-md); background: none; border: none; cursor: pointer; border-bottom: 2px solid transparent;">
                    üìã My Pipelines
                </button>
                <button class="workflow-tab" data-tab="templates" style="padding: var(--spacing-sm) var(--spacing-md); background: none; border: none; cursor: pointer; border-bottom: 2px solid transparent;">
                    üì¶ Templates
                </button>
                <button class="workflow-tab" data-tab="logs" style="padding: var(--spacing-sm) var(--spacing-md); background: none; border: none; cursor: pointer; border-bottom: 2px solid transparent;">
                    üìä Execution Logs
                </button>
            </div>

            <!-- My Pipelines Tab -->
            <div class="workflow-tab-content" id="pipelinesTab">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
                    <h3>Your Pipelines</h3>
                    <button class="btn btn-primary" id="createPipelineBtn">+ Create Pipeline</button>
                </div>

                <div id="pipelinesList" style="display: grid; gap: var(--spacing-md);"></div>

                <div id="noPipelinesMessage" style="display: none; text-align: center; padding: var(--spacing-xl); color: var(--text-muted);">
                    <p style="font-size: 1.2rem; margin-bottom: var(--spacing-sm);">No pipelines yet</p>
                    <p>Create your first pipeline or use a template!</p>
                </div>
            </div>

            <!-- Templates Tab -->
            <div class="workflow-tab-content" id="templatesTab" style="display: none;">
                <h3 style="margin-bottom: var(--spacing-md);">Pipeline Templates</h3>
                <p style="color: var(--text-muted); margin-bottom: var(--spacing-lg);">
                    Start with a pre-built template and customize it to your needs.
                </p>

                <div id="templatesList" style="display: grid; gap: var(--spacing-md);"></div>
            </div>

            <!-- Logs Tab -->
            <div class="workflow-tab-content" id="logsTab" style="display: none;">
                <h3 style="margin-bottom: var(--spacing-md);">Recent Executions</h3>

                <div id="executionLogsList" style="display: grid; gap: var(--spacing-sm);"></div>

                <div id="noLogsMessage" style="display: none; text-align: center; padding: var(--spacing-xl); color: var(--text-muted);">
                    <p>No executions yet</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Pipeline Builder Modal -->
    <div class="modal" id="pipelineBuilderModal" style="display: none;">
        <div class="modal-overlay" id="pipelineBuilderOverlay"></div>
        <div class="modal-body" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <button class="modal-close" id="pipelineBuilderClose" aria-label="Close pipeline builder">&times;</button>
            <h2 style="margin-bottom: var(--spacing-lg);" id="pipelineBuilderTitle">Create Pipeline</h2>

            <form id="pipelineBuilderForm">
                <!-- Basic Info -->
                <div style="margin-bottom: var(--spacing-md);">
                    <label style="display: block; margin-bottom: var(--spacing-xs); font-weight: bold;">Pipeline Name *</label>
                    <input type="text" id="pipelineName" required style="width: 100%; padding: var(--spacing-sm); background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--border-radius);">
                </div>

                <div style="margin-bottom: var(--spacing-md);">
                    <label style="display: block; margin-bottom: var(--spacing-xs); font-weight: bold;">Description</label>
                    <textarea id="pipelineDescription" rows="2" style="width: 100%; padding: var(--spacing-sm); background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--border-radius);"></textarea>
                </div>

                <!-- Trigger -->
                <div style="margin-bottom: var(--spacing-lg);">
                    <label style="display: block; margin-bottom: var(--spacing-xs); font-weight: bold;">Trigger *</label>
                    <select id="pipelineTrigger" style="width: 100%; padding: var(--spacing-sm); background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--border-radius);">
                        <option value="manual">Manual - Run on demand</option>
                        <option value="on_scan">On Scan - When new images are scanned</option>
                        <option value="on_upload">On Upload - When images are uploaded</option>
                    </select>
                </div>

                <!-- Actions -->
                <div style="margin-bottom: var(--spacing-lg);">
                    <label style="display: block; margin-bottom: var(--spacing-xs); font-weight: bold;">Actions *</label>
                    <p style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: var(--spacing-sm);">
                        Actions run sequentially in the order shown.
                    </p>

                    <div id="actionsList" style="margin-bottom: var(--spacing-sm);"></div>

                    <button type="button" class="btn btn-secondary" id="addActionBtn">+ Add Action</button>
                </div>

                <!-- Enabled -->
                <div style="margin-bottom: var(--spacing-lg);">
                    <label style="display: flex; align-items: center; gap: var(--spacing-sm); cursor: pointer;">
                        <input type="checkbox" id="pipelineEnabled" checked>
                        <span>Enable pipeline</span>
                    </label>
                </div>

                <!-- Buttons -->
                <div style="display: flex; gap: var(--spacing-sm); justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" id="cancelPipelineBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="savePipelineBtn">Save Pipeline</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Action Selector Modal -->
    <div class="modal" id="actionSelectorModal" style="display: none;">
        <div class="modal-overlay" id="actionSelectorOverlay"></div>
        <div class="modal-body" style="max-width: 600px;">
            <button class="modal-close" id="actionSelectorClose" aria-label="Close action selector">&times;</button>
            <h3 style="margin-bottom: var(--spacing-md);">Select Action</h3>

            <div id="availableActionsList" style="display: grid; gap: var(--spacing-sm);"></div>
        </div>
    </div>

    <script src="/static/js/app.js"></script>
    <script src="/static/js/research.js"></script>
    <script src="/static/js/workflows.js"></script>
</body>
</html>